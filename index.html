<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFT Staking Dashboard</title>
    <!-- Tailwind CSS via CDN (for testing; use local build for production) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- web3.js via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <!-- WalletConnect v2 SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2.10.0/dist/umd/index.min.js"></script>
    <!-- Favicon to prevent 404 -->
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAFUlEQVR4nGP8//8/A8YYo5GMkYxRAwAWUAu6H5oA7gAAAABJRU5ErkJggg==">
    <style>
        body {
            transition: background-color 0.3s ease;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            max-width: 500px;
            animation: modalopen 0.3s;
        }
        @keyframes modalopen {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #connectWallet {
            transition: all 0.3s ease;
        }
        #connectWallet:hover {
            transform: scale(1.05);
        }
        .staking-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .staking-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-800 min-h-screen">
    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-sm">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fas fa-coins text-3xl text-indigo-600"></i>
                <h1 class="text-2xl font-bold text-gray-800 dark:text-white">NFT Staking</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button id="themeToggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200">
                    <i class="fas fa-moon dark:hidden"></i>
                    <i class="fas fa-sun hidden dark:inline"></i>
                </button>
                <button id="connectWallet" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition-all flex items-center justify-center min-w-[160px]">
                    <span id="walletBtnText">Connect Wallet</span>
                    <div id="walletSpinner" class="loading-spinner hidden ml-2"></div>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Staking Info Card -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 staking-card">
                <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Staking Details</h2>
                <div class="space-y-4">
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Contract Address</p>
                        <p class="text-sm font-mono text-indigo-600 break-all">0x56baF3C662adf4a0c8981E0AA8A5797fE6E72FE6</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Network</p>
                        <p id="networkInfo" class="text-sm font-bold text-gray-800 dark:text-white">Please connect wallet</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Reward Rate</p>
                        <p id="rewardRate" class="text-lg font-bold text-gray-800 dark:text-white">Loading...</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">NFT Contract</p>
                        <p id="nftContract" class="text-sm font-mono text-gray-800 dark:text-white truncate">Loading...</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Reward Token</p>
                        <p id="rewardToken" class="text-sm font-mono text-gray-800 dark:text-white truncate">Loading...</p>
                    </div>
                </div>
            </div>

            <!-- Stake Form -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 staking-card">
                <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Stake Your NFT</h2>
                <form id="stakeForm" class="space-y-4">
                    <div>
                        <label for="tokenId" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">NFT Token ID</label>
                        <input type="number" id="tokenId" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-indigo-600 focus:border-indigo-600">
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition-all flex items-center justify-center">
                        <span id="stakeBtnText">Stake NFT</span>
                        <div id="stakeSpinner" class="loading-spinner hidden ml-2"></div>
                    </button>
                </form>
            </div>

            <!-- Unstake/Reward Form -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 staking-card">
                <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Your Stakes</h2>
                <div id="stakesList" class="mb-4 max-h-40 overflow-y-auto">
                    <p class="text-gray-500 dark:text-gray-400">Connect wallet to view your staked NFTs</p>
                </div>
                <button id="claimRewards" class="w-full px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium mb-2 transition-all flex items-center justify-center">
                    <span id="claimBtnText">Claim Rewards</span>
                    <div id="claimSpinner" class="loading-spinner hidden ml-2"></div>
                </button>
                <form id="unstakeForm">
                    <div class="flex space-x-2">
                        <input type="number" id="unstakeTokenId" class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-indigo-600 focus:border-indigo-600" placeholder="Token ID">
                        <button type="submit" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium transition-all flex items-center justify-center">
                            <span id="unstakeBtnText">Unstake</span>
                            <div id="unstakeSpinner" class="loading-spinner hidden ml-2"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- Wallet Modal -->
    <div id="walletModal" class="modal">
        <div class="modal-content dark:bg-gray-800">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800 dark:text-white">Connect Wallet</h3>
                <span id="closeModal" class="text-2xl cursor-pointer text-gray-500">×</span>
            </div>
            <div class="space-y-4">
                <button id="browserWalletBtn" class="w-full flex items-center justify-center space-x-2 px-4 py-3 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition-all">
                    <img src="https://cdn.jsdelivr.net/gh/atomiclabs/cryptocurrency-icons@d5c68edec1f5eaec59ac77ff2b48144679cebca1/svg/color/eth.svg" alt="Browser Wallet" class="w-6 h-6 rounded-full">
                    <span class="font-medium">Browser Wallet</span>
                </button>
                <button id="walletConnectBtn" class="w-full flex items-center justify-center space-x-2 px-4 py-3 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition-all">
                    <img src="https://cdn.jsdelivr.net/gh/atomiclabs/cryptocurrency-icons@d5c68edec1f5eaec59ac77ff2b48144679cebca1/svg/color/walletconnect.svg" alt="WalletConnect" class="w-6 h-6">
                    <span class="font-medium">WalletConnect</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Transaction Status Modal -->
    <div id="txStatusModal" class="modal">
        <div class="modal-content dark:bg-gray-800">
            <div class="flex justify-between items-center mb-4">
                <h3 id="txStatusTitle" class="text-lg font-bold text-gray-800 dark:text-white">Transaction Status</h3>
                <span id="closeTxStatusModal" class="text-2xl cursor-pointer text-gray-500" style="display: none;">×</span>
            </div>
            <div class="flex flex-col items-center py-4">
                <div id="txSpinner" class="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-4"></div>
                <div id="txSuccessIcon" class="hidden text-green-500 text-5xl mb-4">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div id="txErrorIcon" class="hidden text-red-500 text-5xl mb-4">
                    <i class="fas fa-times-circle"></i>
                </div>
                <p id="txStatusMessage" class="text-center text-gray-700 dark:text-gray-300 mb-4">Processing transaction...</p>
                <a id="txHashLink" href="#" target="_blank" class="hidden text-indigo-600 hover:underline"></a>
            </div>
            <div class="flex justify-end">
                <button id="closeTxStatusBtn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition-all">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // Theme toggle
        const themeToggle = document.getElementById('themeToggle');
        const html = document.documentElement;

        if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            html.classList.add('dark');
        } else {
            html.classList.remove('dark');
        }

        themeToggle.addEventListener('click', () => {
            html.classList.toggle('dark');
            localStorage.setItem('theme', html.classList.contains('dark') ? 'dark' : 'light');
        });

        // DOM elements
        const connectWalletBtn = document.getElementById('connectWallet');
        const walletModal = document.getElementById('walletModal');
        const closeModal = document.getElementById('closeModal');
        const browserWalletBtn = document.getElementById('browserWalletBtn');
        const walletConnectBtn = document.getElementById('walletConnectBtn');
        const networkInfo = document.getElementById('networkInfo');
        const stakeForm = document.getElementById('stakeForm');
        const unstakeForm = document.getElementById('unstakeForm');
        const claimRewardsBtn = document.getElementById('claimRewards');
        const stakesList = document.getElementById('stakesList');
        const rewardRateElement = document.getElementById('rewardRate');
        const nftContractElement = document.getElementById('nftContract');
        const rewardTokenElement = document.getElementById('rewardToken');

        // Spinners
        const walletSpinner = document.getElementById('walletSpinner');
        const stakeSpinner = document.getElementById('stakeSpinner');
        const unstakeSpinner = document.getElementById('unstakeSpinner');
        const claimSpinner = document.getElementById('claimSpinner');

        // Button texts
        const walletBtnText = document.getElementById('walletBtnText');
        const stakeBtnText = document.getElementById('stakeBtnText');
        const unstakeBtnText = document.getElementById('unstakeBtnText');
        const claimBtnText = document.getElementById('claimBtnText');

        // Web3 variables
        let web3;
        let accounts = [];
        let chainId;
        let networkName;
        let stakingContract;
        let walletConnectProvider;

        // Constants
        const STAKING_CONTRACT_ADDRESS = "0x56baF3C662adf4a0c8981E0AA8A5797fE6E72FE6";
        const STAKING_ABI = [
            {
                "inputs": [],
                "name": "claimRewards",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "depositRewards",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "_nftContract",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "_rewardToken",
                        "type": "address"
                    }
                ],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    }
                ],
                "name": "OwnableInvalidOwner",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "account",
                        "type": "address"
                    }
                ],
                "name": "OwnableUnauthorizedAccount",
                "type": "error"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "previousOwner",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "newOwner",
                        "type": "address"
                    }
                ],
                "name": "OwnershipTransferred",
                "type": "event"
            },
            {
                "inputs": [],
                "name": "renounceOwnership",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "stake",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "newOwner",
                        "type": "address"
                    }
                ],
                "name": "transferOwnership",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "unstake",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "user",
                        "type": "address"
                    }
                ],
                "name": "calculateRewards",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "CIRCULATION_THRESHOLD",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "nftContract",
                "outputs": [
                    {
                        "internalType": "contract IERC721",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "owner",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "rewardRate",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "rewardReduced",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "rewardToken",
                "outputs": [
                    {
                        "internalType": "contract IERC20",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "stakes",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "stakedAt",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "TOTAL_SUPPLY",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];
        const NETWORKS = {
            8453: "Base Mainnet",
            84531: "Base Sepolia"
        };

        // Initialize WalletConnect
        async function initWalletConnect() {
            console.log('Initializing WalletConnect...');
            try {
                walletConnectProvider = await EthereumProvider.init({
                    projectId: 'YOUR_WALLET_CONNECT_PROJECT_ID', // Replace with your WalletConnect Project ID
                    chains: [8453], // Base mainnet
                    optionalChains: [84531], // Base Sepolia
                    showQrModal: true,
                    metadata: {
                        name: 'NFT Staking Platform',
                        description: 'Stake NFTs on Base blockchain',
                        url: window.location.origin,
                        icons: ['https://base.org/images/base-icon.svg']
                    }
                });
            } catch (error) {
                console.error('WalletConnect initialization failed:', error);
            }
        }

        // Initialize Web3
        async function initWeb3(provider) {
            console.log('Initializing Web3...');
            try {
                web3 = new Web3(provider);
                accounts = await web3.eth.getAccounts();
                chainId = await web3.eth.getChainId();
                networkName = NETWORKS[chainId] || `Unsupported Network ID: ${chainId}`;
                if (chainId !== 8453) {
                    try {
                        await provider.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x213e' }], // Base mainnet
                        });
                        chainId = 8453;
                        networkName = 'Base Mainnet';
                    } catch (error) {
                        alert('Please switch to Base Mainnet in your wallet.');
                        console.error('Network switch failed:', error);
                        return false;
                    }
                }
                stakingContract = new web3.eth.Contract(STAKING_ABI, STAKING_CONTRACT_ADDRESS);
                return true;
            } catch (error) {
                console.error('Web3 initialization error:', error);
                return false;
            }
        }

        // Connect Browser Wallet
        async function connectBrowserWallet() {
            console.log('Connecting browser wallet...');
            walletSpinner.style.display = 'inline-block';
            walletBtnText.textContent = 'Connecting...';
            try {
                if (!window.ethereum) {
                    throw new Error('No wallet provider detected. Please install MetaMask or another wallet.');
                }
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (await initWeb3(window.ethereum)) {
                    window.ethereum.on('accountsChanged', () => {
                        initWallet();
                        updateUI();
                    });
                    window.ethereum.on('chainChanged', () => {
                        initWallet();
                        updateUI();
                    });
                    walletModal.style.display = 'none';
                    updateUI();
                } else {
                    throw new Error('Failed to initialize Web3');
                }
            } catch (error) {
                alert(`Error connecting wallet: ${error.message}`);
                console.error('Browser wallet connection error:', error);
            } finally {
                walletSpinner.style.display = 'none';
                walletBtnText.textContent = accounts.length > 0 ? 
                    `${accounts[0].substring(0, 6)}...${accounts[0].substring(38)}` :
                    'Connect Wallet';
            }
        }

        // Connect WalletConnect
        async function connectWalletConnect() {
            console.log('Connecting WalletConnect...');
            walletSpinner.style.display = 'inline-block';
            walletBtnText.textContent = 'Connecting...';
            try {
                await walletConnectProvider.connect();
                if (!await initWeb3(walletConnectProvider)) {
                    throw new Error('Failed to initialize Web3 with WalletConnect');
                }
                walletConnectProvider.on('accountsChanged', () => {
                    initWallet();
                    updateUI();
                });
                walletConnectProvider.on('chainChanged', () => {
                    initWallet();
                    updateUI();
                });
                walletConnectProvider.on('disconnect', () => {
                    accounts = [];
                    updateUI();
                });
                walletModal.style.display = 'none';
                updateUI();
            } catch (error) {
                alert(`Error connecting WalletConnect: ${error.message}`);
                console.error('WalletConnect connection error:', error);
            } finally {
                walletSpinner.style.display = 'none';
                walletBtnText.textContent = accounts.length > 0 ? 
                    `${accounts[0].substring(0, 6)}...${accounts[0].substring(38)}` :
                    'Connect Wallet';
            }
        }

        // Update UI
        async function updateUI() {
            console.log('Updating UI...');
            try {
                if (accounts.length > 0) {
                    connectWalletBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                    connectWalletBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                    walletBtnText.textContent = `${accounts[0].substring(0, 6)}...${accounts[0].substring(38)}`;
                    networkInfo.textContent = networkName;
                    const rewardRateValue = await stakingContract.methods.rewardRate().call();
                    rewardRateElement.textContent = (web3.utils.fromWei(rewardRateValue) * 86400).toFixed(2) + " THC/day per NFT";
                    nftContractElement.textContent = await stakingContract.methods.nftContract().call();
                    rewardTokenElement.textContent = await stakingContract.methods.rewardToken().call();
                    await fetchStakes();
                } else {
                    connectWalletBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                    connectWalletBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                    walletBtnText.textContent = 'Connect Wallet';
                    networkInfo.textContent = 'Please connect wallet';
                    stakesList.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400 text-center">Connect wallet to view your staked NFTs</p>';
                    rewardRateElement.textContent = 'Not connected';
                    nftContractElement.textContent = 'Not connected';
                    rewardTokenElement.textContent = 'Not connected';
                }
            } catch (error) {
                console.error('Error updating UI:', error);
                showTransactionStatus('error', `Failed to update UI: ${error.message}`);
            }
        }

        // Fetch staked NFTs
        async function fetchStakes() {
            try {
                const userAddress = accounts[0];
                console.log('Fetching stakes for:', userAddress);
                let stakes = [];
                let i = 0;
                while (true) {
                    try {
                        const stake = await stakingContract.methods.stakes(userAddress, i).call();
                        if (stake.tokenId !== '0' || stake.stakedAt !== '0') {
                            stakes.push({ tokenId: stake.tokenId, stakedAt: stake.stakedAt });
                        }
                        i++;
                    } catch {
                        break;
                    }
                }
                stakesList.innerHTML = stakes.length === 0 
                    ? '<p class="text-sm text-gray-500 dark:text-gray-400 text-center">No staked NFTs</p>'
                    : stakes.map(stake => `
                        <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
                            <p class="text-sm text-gray-800 dark:text-gray-200">Token ID: ${stake.tokenId}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Staked: ${Math.floor((Date.now() - stake.stakedAt * 1000) / 86400000)} days ago</p>
                        </div>
                    `).join('');
            } catch (error) {
                console.error('Error fetching stakes:', error);
                showTransactionStatus('error', `Failed to fetch stakes: ${error.message}`);
            }
        }

        // Show transaction status
        function showTransactionStatus(status, message, txHash = null) {
            txSpinner.classList.add('hidden');
            txSuccessIcon.classList.add('hidden');
            txErrorIcon.classList.add('hidden');
            txHashLink.classList.add('hidden');
            if (status === 'pending') {
                txSpinner.classList.remove('hidden');
                txStatusTitle.textContent = 'Transaction Pending';
            } else if (status === 'success') {
                txSuccessIcon.classList.remove('hidden');
                txStatusTitle.textContent = 'Transaction Successful';
                if (txHash) {
                    txHashLink.href = `https://basescan.org/tx/${txHash}`;
                    txHashLink.textContent = 'View on Basescan';
                    txHashLink.classList.remove('hidden');
                }
            } else {
                txErrorIcon.classList.remove('hidden');
                txStatusTitle.textContent = 'Transaction Failed';
            }
            txStatusMessage.textContent = message;
            txStatusModal.style.display = 'block';
            closeTxStatusModal.style.display = status !== 'pending' ? 'block' : 'none';
        }

        // Stake NFT
        stakeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const tokenId = document.getElementById('tokenId').value;
            if (!tokenId || isNaN(tokenId) || tokenId < 0) {
                alert('Please enter a valid token ID');
                return;
            }
            if (accounts.length === 0) {
                alert('Please connect your wallet first');
                return;
            }
            stakeBtnText.textContent = 'Staking...';
            stakeSpinner.style.display = 'inline-block';
            showTransactionStatus('pending', `Staking NFT with ID ${tokenId}...`);
            try {
                const nftContractAddress = await stakingContract.methods.nftContract().call();
                const nftContract = new web3.eth.Contract([
                    { "constant": true, "inputs": [{ "name": "tokenId", "type": "uint256" }], "name": "ownerOf", "outputs": [{ "name": "", "type": "address" }], "type": "function" },
                    { "constant": false, "inputs": [{ "name": "to", "type": "address" }, { "name": "tokenId", "type": "uint256" }], "name": "approve", "outputs": [], "type": "function" },
                    { "constant": true, "inputs": [{ "name": "tokenId", "type": "uint256" }], "name": "getApproved", "outputs": [{ "name": "", "type": "address" }], "type": "function" }
                ], nftContractAddress);
                const owner = await nftContract.methods.ownerOf(tokenId).call();
                if (owner.toLowerCase() !== accounts[0].toLowerCase()) {
                    throw new Error('You do not own this NFT');
                }
                const approved = await nftContract.methods.getApproved(tokenId).call();
                if (approved.toLowerCase() !== STAKING_CONTRACT_ADDRESS.toLowerCase()) {
                    console.log('Approving NFT for staking...');
                    await nftContract.methods.approve(STAKING_CONTRACT_ADDRESS, tokenId).send({ from: accounts[0] });
                    showTransactionStatus('pending', `Approval for NFT #${tokenId} confirmed. Now staking...`);
                }
                const tx = await stakingContract.methods.stake(tokenId).send({ from: accounts[0] });
                showTransactionStatus('success', `Successfully staked NFT #${tokenId}!`, tx.transactionHash);
                await fetchStakes();
                document.getElementById('tokenId').value = '';
            } catch (error) {
                console.error('Error staking NFT:', error);
                showTransactionStatus('error', error.message || 'Failed to stake NFT');
            } finally {
                stakeBtnText.textContent = 'Stake NFT';
                stakeSpinner.style.display = 'none';
            }
        });

        // Unstake NFT
        unstakeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const tokenId = document.getElementById('unstakeTokenId').value;
            if (!tokenId || isNaN(tokenId) || tokenId < 0) {
                alert('Please enter a valid token ID');
                return;
            }
            if (accounts.length === 0) {
                alert('Please connect your wallet first');
                return;
            }
            unstakeBtnText.textContent = 'Unstaking...';
            unstakeSpinner.style.display = 'inline-block';
            showTransactionStatus('pending', `Unstaking NFT with ID ${tokenId}...`);
            try {
                const tx = await stakingContract.methods.unstake(tokenId).send({ from: accounts[0] });
                showTransactionStatus('success', `Successfully unstaked NFT #${tokenId}!`, tx.transactionHash);
                await fetchStakes();
                document.getElementById('unstakeTokenId').value = '';
            } catch (error) {
                console.error('Error unstaking NFT:', error);
                showTransactionStatus('error', error.message || 'Failed to unstake NFT');
            } finally {
                unstakeBtnText.textContent = 'Unstake';
                unstakeSpinner.style.display = 'none';
            }
        });

        // Claim Rewards
        claimRewardsBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            if (accounts.length === 0) {
                alert('Please connect your wallet first');
                return;
            }
            claimBtnText.textContent = 'Claiming...';
            claimSpinner.style.display = 'inline-block';
            showTransactionStatus('pending', 'Claiming your rewards...');
            try {
                const tx = await stakingContract.methods.claimRewards().send({ from: accounts[0] });
                showTransactionStatus('success', 'Successfully claimed your rewards!', tx.transactionHash);
                await fetchStakes();
            } catch (error) {
                console.error('Error claiming rewards:', error);
                showTransactionStatus('error', error.message || 'Failed to claim rewards');
            } finally {
                claimBtnText.textContent = 'Claim Rewards';
                claimSpinner.style.display = 'none';
            }
        });

        // Event listeners
        connectWalletBtn.addEventListener('click', () => {
            console.log('Connect Wallet button clicked');
            walletModal.style.display = 'block';
        });

        closeModal.addEventListener('click', () => {
            console.log('Close Wallet Modal clicked');
            walletModal.style.display = 'none';
        });

        browserWalletBtn.addEventListener('click', connectBrowserWallet);

        walletConnectBtn.addEventListener('click', connectWalletConnect);

        closeTxStatusModal.addEventListener('click', () => {
            console.log('Close Transaction Modal clicked');
            txStatusModal.style.display = 'none';
        });

        closeTxStatusBtn.addEventListener('click', () => {
            console.log('Close Transaction Modal button clicked');
            txStatusModal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target === walletModal) {
                console.log('Clicked outside Wallet Modal');
                walletModal.style.display = 'none';
            }
            if (event.target === txStatusModal) {
                console.log('Clicked outside Transaction Modal');
                txStatusModal.style.display = 'none';
            }
        });

        // Initialize wallet on load
        async function initWallet() {
            console.log('Initializing wallet...');
            await initWalletConnect();
            if (window.ethereum && window.ethereum.selectedAddress) {
                walletSpinner.style.display = 'inline-block';
                walletBtnText.textContent = 'Connecting...';
                try {
                    if (await initWeb3(window.ethereum)) {
                        updateUI();
                    }
                } catch (error) {
                    console.error('Auto-connect failed:', error);
                } finally {
                    walletSpinner.style.display = 'none';
                    walletBtnText.textContent = accounts.length > 0 ? 
                        `${accounts[0].substring(0, 6)}...${accounts[0].substring(38)}` : 
                        'Connect Wallet';
                }
            }
        }

        window.addEventListener('load', () => {
            console.log('Window loaded, initializing...');
            if (!window.Web3) {
                console.error('web3.js not loaded');
                alert('Failed to load web3.js. Please check your internet connection.');
                return;
            }
            if (!window.EthereumProvider) {
                console.error('WalletConnect SDK not loaded');
                alert('Failed to load WalletConnect SDK. Please check your internet connection.');
                return;
            }
            initWallet();
        });
    </script>
</body>
</html>